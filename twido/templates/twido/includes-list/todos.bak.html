{# tasks listed in rows ul #}
{# vars: page - current page of todos #}
{#       taskstatus - model TaskStatus #}
{% load i18n customer_tags %}<!-- BEGIN list of todos -->


                        <div class="bs-component">
                            <ul class="list-group" id="id_todos">
                                {% for todo in page %}
                                    <li data-id="{{ todo.id }}" class="list-group-item task-item">
                                        <ul class="list-inline">
                                            <li><span title="{% trans 'Status' %}: {{ todo.get_status_text }}" data-name="status" data-type="select" data-pk="{{ todo.id }}"
                                                  data-url="{% url 'todo' todo.id %}"><i class="{{ todo.get_status_glyphicon }}"></i></span></li>
                                            <li class="top-right"><span title="{% trans 'Deadline' %}" class="small" data-name="deadline" data-type="datetime" data-pk="{{ todo.id }}"
                                                  data-url="{% url 'todo' todo.id %}">{{ todo.deadline |default_if_none:'<i class="glyphicon glyphicon-time"></i>' }}</span></li>
                                            <li><span data-name="title" data-type="text" data-pk="{{ todo.id }}"
                                                  data-url="{% url 'todo' todo.id %}">{{ todo.title | url2link }}</span></li>
                                            <li class="bottom-right"><span title="{% trans 'Labels' %}" data-name="labels" data-type="select2" data-pk="{{ todo.id }}"
                                                  data-url="{% url 'todo' todo.id %}">{{ todo.labels| default_if_none:'' }}</span></li>
                                            <li class="buttons small" style="white-space: nowrap; display: none;">
                                                <a name="detail" href="{% url 'todo' todo.id %}" title="{% trans 'Detail' %}" class="label label-info small"><i class="glyphicon glyphicon-list-alt"></i></a>
                                                <a name="del-todo" data-task-id="{{ todo.id }}"  title="{% trans 'Delete' %}" class="label label-danger small"><i class="glyphicon glyphicon-remove"></i></a>
                                            </li>
                                        </ul>
                                    </li>
                                {% endfor %}
                            </ul>
                            {% if not page %}
                                <div class="well">
                                {% trans 'List is empty. Please click "Create Task" button to add.' %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="bs-component text-center">
                            {% include 'includes/paginatition.html' %}
                        </div>

                        <script language="JavaScript" type="text/javascript">

                            $(document).ready(function(){
                                make_todos_editable();
                            });


                            function make_todos_editable() {

                                var todos_container = $("#id_todos");

                                todos_container.find('span[data-name="status"]').tooltip().editable({
                                    escape: false,
                                    source: [
                                        {% for value, text in taskstatus.Choices %}
                                            {value: {{ value }}, text: "{{ text }}"},
                                        {% endfor %}
                                    ],
                                    display: function (value, resp) {
                                        {# Do nothing. Keep for icon display rendering #}
                                    },
                                    success: function (response, newValue) {
                                        if (response.status == 'error')
                                            return response.msg; //msg will be shown in editable form
                                    }
                                }).on('save', function (e, params) {
                                    $(this).html('<i class="' + params.response.status_icon_class + '"></i>')
                                            .attr("data-original-title", '{% trans 'Status' %}: '+params.response.status_text)
                                            .tooltip("show");
                                });


                                todos_container.find('span[data-name="labels"]').tooltip().editable({
                                    showbuttons: 'true',
                                    select2: {
                                        width: '200px',
                                        tags: 'true',
                                        allowClear: 'true',
                                        placeholder: 'enter labels',
                                        multiple: 'true',
                                        minimumInputLength: 2,
                                        delay: 250,
                                        initSelection: function (option, callback) {
                                            var origin = option.closest("li").find("span[data-name='labels']").children();//.text().trim().split(/\s|,/);
                                            var data = [];
                                            $(origin).each(function () {
                                                var t = $(this).text();
                                                data.push({
                                                    id: t,
                                                    text: t
                                                });
                                            });
                                            callback(data);
                                        }
                                    },
                                    display: function (value, resp) {
                                        var target = $(this).closest("li").find("span[data-name='labels']");
                                        if (value && value.length) {
                                            var values = value.toString().split(',');
                                            var html = '';
                                            $(values).each(function () {
                                                html += '<span class="label label-default">' + this + '</span> ';
                                            });
                                            target.html(html);
                                        } else {
{#                                            target.html('<span class="label label-default">...</span>');#}
                                            target.html('<i class="glyphicon glyphicon-tags"></i>');
                                        }
                                    },
                                    success: function (response, newValue) {
                                        if (response.status == 'error') return response.msg; //msg will be shown in editable form
                                    }
                                });


                                todos_container.find('span[data-name="title"]').editable({
                                    {#                mode: 'popup',#}
                                    {#                placement: 'top',#}
                                    allClear: 'true',
{#                                    tpl: "<input type='text' style='width: 400px'>",#}
                                    {#                showbuttons: true,#}
                                    success: function (response, newValue) {
                                        if (response.status == 'error') return response.msg; //msg will be shown in editable form
                                    }
                                });

                                todos_container.find('span[data-name="deadline"]').tooltip().editable({
                                    mode: 'popup',
                                    {#                                    showbuttons: 'true',#}
                                    placement: 'left',
                                    allowClear: 'true',
                                    {#                viewFormat: 'dd/mm/yyyy hh:ii',#}
                                    success: function (response, newValue) {
                                        if (response.status == 'error') return response.msg; //msg will be shown in editable form
                                    }
                                });

                                // todos inline buttons
                                todos_container.find("ul").mouseover(function (e) {
{#                                    var button = $(this).find(".buttons");#}
{#                                    console.log(button.css("display"));#}
{#                                    if (button.css("display") == 'none')#}
                                    $(this).find(".buttons").show();
                                    if (e.target && e.target.nodeName == 'A') {
                                        $(e.target).tooltip('show');
                                    };
                                }).mouseout(function (e) {
                                    $(this).find(".buttons").hide();
                                }).find("a[name='del-todo']").confirmation({
                                    onShow: function(e, obj) {
                                        $(obj).closest('ul').unbind('mouseout');
                                    },
                                    onHide: function(e, obj) {
                                        $(obj).closest('ul').bind('mouseout', function (e) {
                                            $(this).find(".buttons").hide();
                                        });
                                    },
                                    onConfirm: function (e, obj) {
                                        del_task(obj.data('task-id'));
                                    },
                                    html: 'true',
                                    title: '<span class="text-danger">{% trans 'DANGER : Delete this task' %} ?</span>',
                                    placement: 'bottom'
                                });

                            };

                            function del_task(task_id) {
                                var entry = $("#id_todos").find("[data-id='" + task_id + "']");
                                var task_name = entry.find("span[data-name='title']").text();

                                $.ajax("{{ request.path }}", {
                                    method: 'POST',
                                    data: {
                                        action: "del-todo",
                                        task_id: task_id
                                    },
                                    success: function (resp) {
                                        _success('{% trans 'Task "{0}" deleted.' %}'.f(task_name), true);  // message incl
                                        console.debug('Todo task "' + task_name + '" (id=' + task_id + ') deleted.');
                                        entry.fadeOut();
                                    },
                                    error: function (resp) {
                                        _error('{% trans 'Fail to delete task "{0}". <br>Status: {1} <br>Content: {2}' %}'.f(
                                                task_name, resp.status, resp.statusText),
                                                true);    // message incl
                                        entry.fadeOut().fadeIn().fadeOut().fadeIn();
                                        return resp.status + ' ' + resp.statusText;
                                    }
                                });
                            }

                        </script>
<!-- END list of todos -->